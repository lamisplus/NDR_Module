<?xml version="1.0" encoding="utf-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">

    <property name="autoIncrement" value="true"/>
    <changeSet id="20200405133945-01" author="amos-data-fi">
        <createTable tableName="ndr_code_set">
            <column name="code_set_nm" type="varchar(64)">
                <constraints nullable="false"/>
            </column>
            <column name="code" type="varchar(64)">
                <constraints nullable="false"/>
            </column>
            <column name="code_description" type="varchar(64)">
                <constraints nullable="false"/>
            </column>
            <column name="alt_description" type="varchar(64)"/>
            <column name="sys_description" type="varchar(64)"/>
        </createTable>
    </changeSet>

    <changeSet id="20220705133945-02" author="amos-data-fi">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*)
                FROM ndr_code_set;
            </sqlCheck>
        </preConditions>
        <sqlFile dbms="postgresql"
                 path="sql/ndr-code-set.sql"
                 relativeToChangelogFile="true"
                 splitStatements="false"
                 stripComments="true"/>
    </changeSet>

    <changeSet id="2022075133945-03-3" author="amos-data-fi">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="ndr_facility"/>
            </not>
        </preConditions>
        <createTable tableName="ndr_facility">
            <column name="id" type="JAVA.UTIL.UUID">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="name" type="varchar(128)">
                <constraints nullable="false" unique="true"/>

            </column>
            <column name="facility_local_id" type="BIGINT">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="datim_id" type="varchar(32)">
                <constraints nullable="false" unique="true"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet failOnError="true" id="2022075133945-05" author="amos-data-fi">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="ndr_message_log"/>
            </not>
        </preConditions>
       <sql>
           CREATE TABLE IF NOT  EXISTS  ndr_message_log
           (
               id           INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
               identifier   VARCHAR(64)                              NOT NULL,
               file         VARCHAR(128)                             NOT NULL,
               last_updated TIMESTAMP WITHOUT TIME ZONE,
               CONSTRAINT pk_ndr_message_log PRIMARY KEY (id)
           );
        </sql>
    </changeSet>

    <changeSet id="2022075133945-06" author="amos-data-fi">
        <createIndex tableName="ndr_message_log" indexName="idx_message_identifier">
            <column name="identifier"/>
        </createIndex>
    </changeSet>



    <changeSet  failOnError="true" id="202207922274-02" author="amos-data-fi">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="ndr_xml_status"/>
            </not>
        </preConditions>
        <sql>
            CREATE TABLE  ndr_xml_status
            (
                id            INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
                facility_id   BIGINT                                   NOT NULL,
                files         INTEGER                                  NOT NULL,
                file_name     VARCHAR(255),
                last_modified TIMESTAMP WITHOUT TIME ZONE              NOT NULL,
                push_identifier VARCHAR(255),
                percentage_pushed BIGINT,
                completely_pushed boolean,

                CONSTRAINT pk_ndr_xml_status PRIMARY KEY (id)
            );
        </sql>
    </changeSet>
</databaseChangeLog>
